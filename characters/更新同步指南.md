# 武林外传人物图鉴 - 数据管理与协作指南

本文档整合了项目的数据更新流程、协作规范及工具使用指南，是团队开发和数据维护的权威参考。

---

## 1. 项目结构与数据流

本项目采用数据源与静态资源分离的架构。

*   **数据源 (Source)**: `src/data/source/`
    *   `data/*.json`: 人物数据核心文件。
    *   `events/*.json`: 通用事件数据。
    *   `templates/`: 数据模板。
*   **构建产物 (Build)**: `public/resources/`
    *   `characters-data.js`: 供前端使用的聚合数据。
*   **图片资源**:
    *   `public/characters/avatars/`: 存放WebP格式的头像。

---

## 2. 添加与更新人物数据

您可以选择使用自动化工具（推荐）或手动操作。

### 方法一：使用交互式命令行工具 (推荐)

我们修复并更新了 `add_character.js` 脚本，使其适配新的目录结构。

1.  打开终端 (Terminal)。
2.  运行命令：
    ```bash
    node add_character.js
    ```
3.  按提示输入姓名、职业等信息。
4.  脚本会自动在 `src/data/source/data/` 生成 JSON 文件。

### 方法二：手动创建

1.  参考 `src/data/source/templates/character_template.json`。
2.  新建 JSON 文件于 `src/data/source/data/`，命名格式建议为 `xing-ming.json`。
3.  **必填字段**：
    *   `id`: 全局唯一标识符 (kebab-case)。
    *   `name`: 显示名称。
    *   `avatar`: 图片路径 (指向 `characters/avatars/portraits/xxx.webp`)。
    *   `description`: 人物简介。
    *   `category`: 分类 (`tongfu`, `guest`, `other`)。

### 关键步骤：数据同步

无论通过哪种方式修改了数据，**必须**执行以下命令将变更同步到前端：

```bash
npm run update-data
```

此命令会运行 `build_data.js`，合并所有 JSON 并生成前端所需的 JS 文件。

---

## 3. 图片资源管理

*   **路径**：将图片放入 `public/characters/avatars/portraits/`。
*   **格式**：推荐使用 **WebP** 格式以优化性能。
*   **工具**：项目提供了 `optimize_images.js` 脚本（需安装 sharp 库）用于批量转换图片，但目前建议直接使用 WebP 图片。

---

## 4. 协作与部署流程

### 4.1 提交代码 (Git Workflow)

1.  **拉取最新代码**：`git pull`
2.  **创建/切换分支**：`git checkout -b feature/add-new-char`
3.  **修改数据**：添加 JSON 或图片。
4.  **本地验证**：
    *   运行 `npm run update-data`
    *   运行 `npm run dev` 启动预览，检查页面是否正常显示新角色。
5.  **提交更改**：
    ```bash
    git add .
    git commit -m "feat: add character zhu-wushuang"
    ```
6.  **推送分支**：`git push origin feature/add-new-char`

### 4.2 部署上线

GitHub Pages 会自动部署 `main` 分支的内容。

1.  确保本地构建无误：`npm run build`
2.  合并代码到 `main` 分支并推送。

---

## 5. 常见问题 (FAQ)

### Q1: 修改了 JSON 但页面没变化？
**A:** 忘记运行 `npm run update-data` 了。前端不直接读取 JSON 源文件，而是读取构建后的 `characters-data.js`。

### Q2: 图片不显示？
**A:**
1.  检查 JSON 中的 `avatar` 路径是否正确（应以 `characters/avatars/...` 开头，**不要**带 `public/`）。
2.  检查文件扩展名是否匹配（代码中优先使用 `.webp`）。

### Q3: 之前的 `characters/` 目录还有用吗？
**A:** 根目录下的旧 `characters/` 文件夹已归档（Archive），仅作备份参考。**请勿**在该目录下修改数据，所有有效数据均位于 `src/data/source/` 和 `public/` 中。

---

## 6. 数据结构参考

```json
{
    "id": "bai-zhantang",
    "name": "白展堂",
    "avatar": "characters/avatars/portraits/hero-portrait.webp",
    "category": "tongfu",
    "description": "...",
    "personality": {
        "mbti": "ISFP",
        "traits": { "胆小": 80, "善良": 85 }
    }
}
```
